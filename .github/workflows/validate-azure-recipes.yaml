name: Validate Azure Recipes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Radius version number to use (e.g. 0.51.0, 0.51.0-rc1, edge).'
        required: false
        default: 'edge'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  validate-azure-recipes:
    runs-on: ubuntu-latest
    name: Validate Azure Recipes
    environment: azure
    permissions:
      id-token: write
      contents: read
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      AZURE_AUTH_MODE: wi
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set Azure Test Context
        run: |
          LOCATION="${AZURE_LOCATION:-${{ vars.AZURE_LOCATION }}}"
          if [ -z "$LOCATION" ]; then
            LOCATION="westus3"
          fi
          RG="radtest-${{ github.run_id }}-${{ github.run_attempt }}"
          # Temporary override for targeted testing against an existing resource group.
          RG="shruthikumar"
          STATE_FILE=".azure-test-state"
          echo "AZURE_LOCATION=$LOCATION" >> "$GITHUB_ENV"
          echo "AZURE_RESOURCE_GROUP=$RG" >> "$GITHUB_ENV"
          echo "AZURE_WORKSPACE_NAME=default" >> "$GITHUB_ENV"
          echo "AZURE_ENVIRONMENT_NAME=default" >> "$GITHUB_ENV"
          echo "AZURE_TEST_STATE_FILE=$STATE_FILE" >> "$GITHUB_ENV"

      - name: Create Azure Resource Group
        run: |
          current_time=$(date +%s)
          az group create \
            --location "$AZURE_LOCATION" \
            --name "$AZURE_RESOURCE_GROUP" \
            --subscription "$AZURE_SUBSCRIPTION_ID" \
            --tags creationTime=$current_time
          while [ "$(az group exists --name "$AZURE_RESOURCE_GROUP" --subscription "$AZURE_SUBSCRIPTION_ID")" = "false" ]; do
            sleep 2
          done

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 16

      - name: Set up ORAS
        uses: oras-project/setup-oras@v1
        with:
          version: '1.2.0'

      - name: Install Radius CLI
        run: make install-radius-cli RAD_VERSION="${{ inputs.version || 'edge' }}"

      - name: Create Radius Cluster
        run: make create-radius-cluster
        env:
          TEST_AZURE_OIDC_JSON: ${{ secrets.TEST_AZURE_OIDC_JSON }}

      - name: Configure Azure Provider
        run: make configure-azure-provider

      - name: Verify Azure Workload Identity Setup
        env:
          TEST_AZURE_OIDC_JSON: ${{ secrets.TEST_AZURE_OIDC_JSON }}
        run: |
          echo "=== 0. Checking webhook installation ==="
          echo "Helm releases:"
          helm list -n radius-default
          echo ""
          echo "Deployments in radius-default:"
          kubectl get deployments -n radius-default
          echo ""
          echo "Pods in radius-default:"
          kubectl get pods -n radius-default
          echo ""
          if kubectl get deployment -n radius-default workload-identity-webhook &>/dev/null; then
            echo "Webhook deployment exists. Describing deployment:"
            kubectl describe deployment workload-identity-webhook -n radius-default
          else
            echo "❌ Webhook deployment not found"
          fi
          echo ""
          echo "Checking webhook configuration selectors:"
          kubectl get mutatingwebhookconfiguration azure-wi-webhook-mutating-webhook-configuration -o jsonpath='{.webhooks[0].namespaceSelector}'
          echo ""
          echo "Webhook object selector:"
          kubectl get mutatingwebhookconfiguration azure-wi-webhook-mutating-webhook-configuration -o jsonpath='{.webhooks[0].objectSelector}'
          echo ""
          echo ""
          echo "Checking radius-system namespace labels:"
          kubectl get namespace radius-system -o jsonpath='{.metadata.labels}'
          echo ""
          echo ""
          
          echo "=== 1. Checking OIDC issuer accessibility ==="
          if ! ISSUER=$(printf '%s' "$TEST_AZURE_OIDC_JSON" | jq -r '.AZURE_OIDC_ISSUER' 2>/dev/null); then
            echo "❌ Failed to parse TEST_AZURE_OIDC_JSON - JSON is malformed"
            exit 1
          fi
          echo "Testing discovery document..."
          if curl -sf -o /dev/null "$ISSUER/.well-known/openid-configuration"; then
            echo "✅ Discovery document reachable"
          else
            echo "❌ Discovery document not accessible"
          fi
          echo "Testing JWKS..."
          if curl -sf -o /dev/null "$ISSUER/.well-known/openid-configuration/jwks"; then
            echo "✅ JWKS endpoint reachable"
          else
            echo "❌ JWKS endpoint not accessible"
          fi
          
          echo ""
          echo "=== 2. Checking service account labels ==="
          kubectl get serviceaccount -n radius-system -o json | \
            jq -r '.items[] | "\(.metadata.name): " + (if (.metadata.labels // {})["azure.workload.identity/client-id"] then "LABEL_PRESENT" else "LABEL_MISSING" end)'
          
          echo ""
          echo "=== 3. Checking pod annotations ==="
          kubectl get pods -n radius-system -o json | \
            jq -r '.items[] | "\(.metadata.name): " + (if (.metadata.annotations // {})["azure.workload.identity/use"] then "ANNOTATION_PRESENT" else "ANNOTATION_MISSING" end)'
          
          echo ""
          echo "=== 4. Checking AZURE_CLIENT_ID environment variable ==="
          kubectl get pods -n radius-system -o json | \
            jq -r '.items[] | (.metadata.name) as $name | {name: $name, env: [(.spec.containers[]?.env[]? | select(.name=="AZURE_CLIENT_ID"))]} | "\(.name): " + (if (.env | length) > 0 then "AZURE_CLIENT_ID_PRESENT" else "NOT_SET" end)'
          
          echo ""
          echo "=== 5. Checking projected service account token ==="
          kubectl get pods -n radius-system -o json | \
            jq -r '.items[] | "\(.metadata.name): " + (if .spec.volumes[]? | select(.name=="azure-identity-token") then "TOKEN_VOLUME_MOUNTED" else "NO_TOKEN_VOLUME" end)'
          
          echo ""
          echo "=== 6. Federated credential requirements ==="
          echo "✓ Issuer must match AZURE_OIDC_ISSUER from secret"
          echo "✓ Subject must be: system:serviceaccount:radius-system:<service-account-name>"
          echo "✓ Audience must be: api://AzureADTokenExchange"

      - name: Build Azure Recipes
        run: make build-azure-recipes

      - name: Test Azure Recipes
        run: make test-azure-recipes

      - name: Cleanup Azure Resources
        if: always()
        run: make cleanup-azure-resources
